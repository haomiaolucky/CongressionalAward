<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Congressional Award Tracker</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/themes.css">
    <script src="/js/navbar.js"></script>
    <script src="/js/theme-switcher.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
        }
        .container { color: rgba(255, 255, 255, 0.9); }
        h1, h2, h3 { color: #fff; text-shadow: 0 0 20px rgba(0, 255, 234, 0.5); }
        p { color: rgba(255, 255, 255, 0.8); }
        strong { color: rgba(255, 255, 255, 0.95); }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 255, 234, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 255, 234, 0.1);
        }
        .card-header {
            background: rgba(0, 255, 234, 0.1);
            border-bottom: 1px solid rgba(0, 255, 234, 0.3);
        }
        .card-body { background: transparent; }
        .table { color: rgba(255, 255, 255, 0.9) !important; background: transparent !important; }
        .table th { color: rgba(255, 255, 255, 0.9) !important; }
        .table td { color: rgba(255, 255, 255, 0.9) !important; }
        .table thead { background: transparent !important; border-bottom: 2px solid rgba(0, 255, 234, 0.3); }
        .table thead tr { background: transparent !important; }
        .table thead th { color: rgba(255, 255, 255, 0.9) !important; font-weight: 600 !important; background: transparent !important; }
        .table tbody tr { border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: transparent !important; }
        .table tbody tr:hover { background: rgba(0, 255, 234, 0.05) !important; }
        .text-center { color: rgba(255, 255, 255, 0.9) !important; }
        .form-control, .form-select {
            background: rgba(0, 255, 234, 0.05);
            border: 1px solid rgba(0, 255, 234, 0.2);
            color: #fff;
        }
        .form-control:focus, .form-select:focus {
            background: rgba(0, 255, 234, 0.1);
            border-color: #00ffea;
            box-shadow: 0 0 15px rgba(0, 255, 234, 0.3);
            color: #fff;
        }
        .form-control::placeholder { color: rgba(255, 255, 255, 0.5); }
        .form-select option { background: #1a1a2e; color: #fff; }
        .btn-primary {
            background: linear-gradient(135deg, #00ffea, #00d4ff);
            border: none;
            color: #0f0c29;
            font-weight: 600;
            box-shadow: 0 0 20px rgba(0, 255, 234, 0.5);
        }
    </style>
</head>
<body style="min-height: 100vh;">

    <div class="container" style="margin-top: 2rem;">
        <div id="loading" class="text-center">
            <div class="spinner"></div>
            <p>Loading your dashboard...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Student Info Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2>Welcome, <span id="studentName"></span>! üëã</h2>
                    <span class="badge badge-success" id="currentLevel"></span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-3">
                            <p><strong>Email:</strong> <span id="email"></span></p>
                            <p><strong>Grade:</strong> <span id="grade"></span></p>
                        </div>
                        <div class="col-3">
                            <p><strong>School:</strong> <span id="school"></span></p>
                            <p><strong>Start Date:</strong> <span id="startDate"></span></p>
                        </div>
                        <div class="col-3">
                            <p><strong>Membership Expires:</strong> <span id="expireDate"></span></p>
                        </div>
                        <div class="col-3 text-right">
                            <a href="/submit-log" class="btn btn-primary btn-lg">‚ûï Submit New Record</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hours Summary Cards -->
            <div class="row" style="margin-top: 1.5rem;">
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 style="color: #00ffea;"><span id="volunteerHours">0</span>h</h3>
                            <p>Volunteer Service</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 style="color: #00d4ff;"><span id="pdHours">0</span>h</h3>
                            <p>Personal Development</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 style="color: #00ffea;"><span id="pfHours">0</span>h</h3>
                            <p>Physical Fitness</p>
                        </div>
                    </div>
                </div>
                <div class="col-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <h3 style="color: #00d4ff;"><span id="expeditions">0</span></h3>
                            <p>Expeditions</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <h3>Hours by Category</h3>
                </div>
                <div class="card-body">
                    <canvas id="hoursChart" height="80"></canvas>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3>My Activity Log</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <button class="btn btn-success btn-sm" onclick="exportToExcel()" title="Export to Excel">
                            üìä Export Excel
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="exportToPDF()" title="Export to PDF">
                            üìÑ Export PDF
                        </button>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search activities..." style="display: inline-block; width: 250px; margin-right: 10px;">
                        <select id="filterCategory" class="form-select" style="display: inline-block; width: 200px;">
                            <option value="">All Categories</option>
                            <option value="Volunteer">Volunteer</option>
                            <option value="Personal Development">Personal Development</option>
                            <option value="Physical Fitness">Physical Fitness</option>
                            <option value="Expedition">Expedition</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <table class="table" id="logsTable">
                        <thead>
                            <tr>
                                <th>Proof</th>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Category</th>
                                <th>Hours</th>
                                <th>Supervisor</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logsBody">
                            <tr>
                                <td colspan="7" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allLogs = [];
        let chart = null;

        async function loadDashboard() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                // Load user info
                const userResponse = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await userResponse.json();

                // Load dashboard data
                const dashboardResponse = await fetch('/api/students/dashboard', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                // Check if membership expired
                if (dashboardResponse.status === 403) {
                    const errorData = await dashboardResponse.json();
                    if (errorData.expired) {
                        // Redirect to expired page with date
                        window.location.href = `/membership-expired.html?date=${errorData.expireDate}`;
                        return;
                    } else if (errorData.inactive) {
                        alert('Your account is inactive. Please contact your administrator.');
                        localStorage.removeItem('token');
                        localStorage.removeItem('user');
                        window.location.href = '/login';
                        return;
                    }
                }
                
                const dashboard = await dashboardResponse.json();

                // Load logs
                const logsResponse = await fetch('/api/logs', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                allLogs = await logsResponse.json();

                // Display data
                displayUserInfo(user, dashboard);
                displayHoursSummary(dashboard.hours);
                createChart(dashboard.hours);
                displayLogs(allLogs);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                alert('Failed to load dashboard data');
            }
        }

        function displayUserInfo(user, dashboard) {
            document.getElementById('studentName').textContent = user.StudentName;
            document.getElementById('email').textContent = user.Email;
            document.getElementById('grade').textContent = user.Grade + 'th Grade';
            document.getElementById('school').textContent = user.SchoolName || 'N/A';
            document.getElementById('startDate').textContent = new Date(user.StartDate).toLocaleDateString();
            document.getElementById('currentLevel').textContent = dashboard.student.currentLevel;
            
            // Display expire date with color coding
            const expireDateElement = document.getElementById('expireDate');
            if (dashboard.student.expireDate) {
                const expireDate = new Date(dashboard.student.expireDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const isExpired = expireDate < today;
                const daysUntilExpire = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
                const isExpiringSoon = daysUntilExpire > 0 && daysUntilExpire <= 30;
                
                const dateStr = expireDate.toLocaleDateString();
                if (isExpired) {
                    expireDateElement.innerHTML = `<span style="color: #ff4444; font-weight: bold;">${dateStr} ‚ö†Ô∏è EXPIRED</span>`;
                } else if (isExpiringSoon) {
                    expireDateElement.innerHTML = `<span style="color: #ffaa00; font-weight: bold;">${dateStr} ‚è∞ (${daysUntilExpire} days left)</span>`;
                } else {
                    expireDateElement.innerHTML = `<span style="color: rgba(255, 255, 255, 0.9);">${dateStr}</span>`;
                }
            } else {
                expireDateElement.textContent = 'Not set';
            }
        }

        function displayHoursSummary(hours) {
            document.getElementById('volunteerHours').textContent = hours.volunteer;
            document.getElementById('pdHours').textContent = hours.personalDevelopment;
            document.getElementById('pfHours').textContent = hours.physicalFitness;
            document.getElementById('expeditions').textContent = hours.expeditions;
        }

        function createChart(hours) {
            const ctx = document.getElementById('hoursChart').getContext('2d');
            
            // Detect current theme
            const isLightTheme = document.documentElement.getAttribute('data-theme') === 'light';
            const textColor = isLightTheme ? '#000000' : 'rgba(255, 255, 255, 0.8)';
            const gridColor = isLightTheme ? 'rgba(99, 102, 241, 0.2)' : 'rgba(0, 255, 234, 0.1)';
            const barColors = isLightTheme ? ['#8b5cf6', '#ec4899', '#06b6d4', '#10b981'] : ['#00ffea', '#00d4ff', '#00ffea', '#00d4ff'];
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Volunteer', 'Personal Development', 'Physical Fitness', 'Expeditions'],
                    datasets: [{
                        label: 'Hours/Events',
                        data: [hours.volunteer, hours.personalDevelopment, hours.physicalFitness, hours.expeditions],
                        backgroundColor: barColors
                    }]
                },
                options: {
                    responsive: true,
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            ticks: { 
                                color: textColor,
                                font: { 
                                    weight: '700',
                                    size: 13
                                }
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { 
                                color: textColor,
                                font: { 
                                    weight: '700',
                                    size: 13
                                }
                            },
                            grid: { color: gridColor }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { 
                                color: textColor,
                                font: { 
                                    weight: '700',
                                    size: 13
                                }
                            }
                        }
                    }
                }
            });
        }

        function displayLogs(logs) {
            const tbody = document.getElementById('logsBody');
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No activities yet. Click "Submit New Record" to add one!</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => `
                <tr>
                    <td>
                        ${log.Proof ? `
                            <a href="${log.Proof}" target="_blank" title="View full image">
                                <img src="${log.Proof}" alt="Proof" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 2px solid rgba(0, 255, 234, 0.3); cursor: pointer;">
                            </a>
                        ` : '<span style="color: rgba(255, 255, 255, 0.5);">No proof</span>'}
                    </td>
                    <td>${new Date(log.Date).toLocaleDateString()}</td>
                    <td>${log.ActivityName}</td>
                    <td>${log.Category}</td>
                    <td>${log.Hours}</td>
                    <td>${log.SupervisorName}</td>
                    <td><span class="badge badge-${log.Status === 'Approved' ? 'success' : log.Status === 'Pending' ? 'warning' : 'danger'}">${log.Status}</span></td>
                    <td>
                        ${log.Status === 'Rejected' ? `
                            <button class="btn btn-primary btn-sm" onclick="editLog(${log.LogID})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteLog(${log.LogID})">Delete</button>
                        ` : '-'}
                    </td>
                </tr>
            `).join('');
        }

        function filterLogs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;

            const filtered = allLogs.filter(log => {
                const matchesSearch = log.ActivityName.toLowerCase().includes(searchTerm) || 
                                     log.SupervisorName.toLowerCase().includes(searchTerm);
                const matchesCategory = !category || log.Category === category;
                return matchesSearch && matchesCategory;
            });

            displayLogs(filtered);
        }

        // Add image error handling
        document.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG') {
                e.target.style.display = 'none';
                e.target.parentElement.innerHTML = '<span style="color: rgba(255, 255, 255, 0.5); font-size: 0.8em;">Image unavailable</span>';
            }
        }, true);

        async function editLog(logId) {
            const log = allLogs.find(l => l.LogID === logId);
            if (!log) return;
            
            // Store log data for editing
            localStorage.setItem('editLog', JSON.stringify(log));
            window.location.href = '/submit-log?edit=' + logId;
        }

        async function deleteLog(logId) {
            if (!confirm('Are you sure you want to delete this log?')) return;
            
            const token = localStorage.getItem('token');
            try {
                const response = await fetch(`/api/logs/${logId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    alert('Log deleted successfully');
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to delete log');
                }
            } catch (error) {
                console.error('Error deleting log:', error);
                alert('Failed to delete log');
            }
        }

        // Export to Excel function
        function exportToExcel() {
            if (allLogs.length === 0) {
                alert('No data to export');
                return;
            }

            // Prepare data for Excel
            const excelData = allLogs.map(log => ({
                'Date': new Date(log.Date).toLocaleDateString(),
                'Activity': log.ActivityName,
                'Category': log.Category,
                'Hours': log.Hours,
                'Supervisor': log.SupervisorName,
                'Status': log.Status,
                'Notes': log.Notes || '',
                'Proof Image': log.Proof || 'No proof',
                'Submitted': new Date(log.CreatedAt).toLocaleDateString()
            }));

            // Create workbook and worksheet
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);

            // Set column widths
            ws['!cols'] = [
                { wch: 12 },  // Date
                { wch: 25 },  // Activity
                { wch: 20 },  // Category
                { wch: 8 },   // Hours
                { wch: 20 },  // Supervisor
                { wch: 10 },  // Status
                { wch: 30 },  // Notes
                { wch: 50 },  // Proof Image (URL)
                { wch: 12 }   // Submitted
            ];

            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(wb, ws, 'Activity Log');

            // Generate filename with current date
            const filename = `Activity_Log_${new Date().toISOString().split('T')[0]}.xlsx`;
            
            // Download file
            XLSX.writeFile(wb, filename);
            
            console.log('Excel file exported successfully');
        }

        // Export to PDF function
        function exportToPDF() {
            if (allLogs.length === 0) {
                alert('No data to export');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

            // Get student info
            const studentName = document.getElementById('studentName').textContent;
            const studentEmail = document.getElementById('email').textContent;
            
            // Add title
            doc.setFontSize(18);
            doc.text('Congressional Award Activity Log', 14, 15);
            
            // Add student info
            doc.setFontSize(10);
            doc.text(`Student: ${studentName}`, 14, 22);
            doc.text(`Email: ${studentEmail}`, 14, 27);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 32);

            // Prepare table data
            const tableData = allLogs.map(log => [
                new Date(log.Date).toLocaleDateString(),
                log.ActivityName,
                log.Category,
                log.Hours.toString(),
                log.SupervisorName,
                log.Status,
                log.Proof ? 'View' : 'No proof'
            ]);

            // Add table
            doc.autoTable({
                startY: 38,
                head: [['Date', 'Activity', 'Category', 'Hours', 'Supervisor', 'Status', 'Proof']],
                body: tableData,
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 102, 204],
                    textColor: 255,
                    fontSize: 9,
                    fontStyle: 'bold'
                },
                bodyStyles: {
                    fontSize: 8
                },
                columnStyles: {
                    0: { cellWidth: 25 },  // Date
                    1: { cellWidth: 60 },  // Activity
                    2: { cellWidth: 40 },  // Category
                    3: { cellWidth: 20 },  // Hours
                    4: { cellWidth: 45 },  // Supervisor
                    5: { cellWidth: 25 },  // Status
                    6: { cellWidth: 25 }   // Proof
                },
                didDrawCell: function(data) {
                    // Add clickable links for proof images
                    if (data.column.index === 6 && data.cell.section === 'body') {
                        const log = allLogs[data.row.index];
                        if (log.Proof) {
                            doc.setTextColor(0, 0, 255);
                            doc.textWithLink('View', data.cell.x + 2, data.cell.y + 5, {
                                url: log.Proof
                            });
                            doc.setTextColor(0, 0, 0);
                        }
                    }
                }
            });

            // Add summary at the bottom
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text('Hours Summary:', 14, finalY);
            doc.text(`Volunteer: ${document.getElementById('volunteerHours').textContent}h`, 14, finalY + 6);
            doc.text(`Personal Development: ${document.getElementById('pdHours').textContent}h`, 60, finalY + 6);
            doc.text(`Physical Fitness: ${document.getElementById('pfHours').textContent}h`, 120, finalY + 6);
            doc.text(`Expeditions: ${document.getElementById('expeditions').textContent}`, 180, finalY + 6);

            // Generate filename
            const filename = `Activity_Log_${new Date().toISOString().split('T')[0]}.pdf`;
            
            // Download PDF
            doc.save(filename);
            
            console.log('PDF exported successfully');
        }

        document.getElementById('searchInput').addEventListener('input', filterLogs);
        document.getElementById('filterCategory').addEventListener('change', filterLogs);

        loadDashboard();

        // Load navbar for dashboard page
        loadNavbar('dashboard');

        // Setup logout handler after navbar is loaded
        setTimeout(() => {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                });
            }
        }, 100);
    </script>
</body>
</html>
